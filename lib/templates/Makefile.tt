#-------------------------------------------------------------------------
#
#   ppm <%= conf.name %> Makefile
#
#   Generated by PPM CG
#
#-------------------------------------------------------------------------
PROGRAM  = <%= conf.binary %>

PPMDIR    = <%= conf.ppm.base_path %>
PPMNUMDIR = <%= conf.ppm.numerics.base_path %>

# Flags and settings, when you compile
FC      = <%= conf.build.compiler %>
LDFLAGS = <%= conf.ppm.build.ldflags %> -L$(PPMDIR)/lib -L$(PPMNUMDIR)/lib -lppm -lmetis # -lppmnumerics
OPT     = <%= conf.build.optflags %>
INCL    = -I$(PPMDIR)/include/ppm -I$(PPMNUMDIR)/include/ppm

### Usually you should not change these variables below.

# Collecting compilerflags in one variable.
FFLAGS= $(OPT) $(INCL)

###### You shouldn't need to change anything below this line #############
PPM  := ppm
SED  := <%= conf.build.sed %>
DEPS := $(PPMDIR)/utils/deps.sh
LOG  := compile.log
RUN  := $(PPMDIR)/utils/runcmd.sh

# Directory where to move the program when running 'make install'
SOURCEDIR  = ..
FORTRANDIR = .
BUILDDIR   = obj
DESTDIR    = ../bin

# generic variables

SOURCES := $(notdir $(wildcard $(SOURCEDIR)/*.ppm))
FORTRAN := $(SOURCES:%.ppm=$(FORTRANDIR)/%.f03)
OBJECTS := $(SOURCES:%.ppm=$(BUILDDIR)/%.o)
DEPENDENCIES := $(SOURCES:%.ppm=$(BUILDDIR)/%.d)


####### Build and Install Targets ########################################
all: $(PROGRAM)

generate: $(FORTRAN)

# Dont delete the given intermediate files
.SECONDARY: #$(DEPENDENCIES)

PPCMD = $(PPM) pp $< -M $(SOURCEDIR)/macros -o $@
$(FORTRANDIR)/%.f03 : $(SOURCEDIR)/%.ppm
	@printf "  PPM  %-42s" $<; \
	$(RUN) "$(PPCMD)" $(LOG) "Preprocessing Error"

ENV = CPP="cpp" SED="$(SED)" OBJDIR="$(BUILDDIR)" SRCDIR="$(FORTRANDIR)"
DEPCMD = $(DEPS) $< $@
$(BUILDDIR)/%.d : $(FORTRANDIR)/%.f03 $(SOURCEDIR)/%.ppm
	@printf "  DEP  %-42s" $<; \
	$(ENV) $(RUN) "$(DEPCMD)" $(LOG) "Dependency Error"

COMPILECMD = $(FC) $(INCL) $(FFLAGS) -c -o $@ $<
$(BUILDDIR)/%.o : $(FORTRANDIR)/%.f03
	@printf "  FC   %-42s" $<; \
	$(RUN) "$(COMPILECMD)" $(LOG) "Compile Error"

LINKCMD = $(FC) $(OBJECTS) -o $@ $(LDFLAGS)
$(PROGRAM): $(OBJECTS)
	@printf " LINK  %-42s" $@; \
	$(RUN) "$(LINKCMD)" $(LOG) "Linking Error" \
	&& mv $(PROGRAM) $(DESTDIR)

###### Cleaning up #######################################################
clean:
	rm $(BUILDDIR)/*.o $(BUILDDIR)/*.mod

cleanall: clean
	rm $(FORTRANDIR)/*.f03 $(PROGRAM)
